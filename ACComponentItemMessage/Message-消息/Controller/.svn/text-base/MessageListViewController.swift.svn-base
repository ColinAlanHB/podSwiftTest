//
//  MessageListViewController.swift
//  citizencloud
//
//  Created by 沈移动 on 2018/4/11.
//  Copyright © 2018年 linewell. All rights reserved.
//

import Foundation
import ACComponentItemLib

/// 消息列表
class MessageListViewController: INNOBaseViewController {
    
    // 消息标识
    var id: String?
    
    fileprivate let CellID = "messageCellID"
    
    // 列表
    fileprivate lazy var myTableview : INNOMJUITableView<UserNotifyMessageListDTO, IDDatalistParams> = {
        
        let tableview = INNOMJUITableView<UserNotifyMessageListDTO, IDDatalistParams>(
            frame: CGRect(x: 0,
                          y: navBarBottom(),
                          width: screenWidth(),
                          height: pageHeight()),
            style: .grouped)
        tableview.inno_serviceUrl = "/tongplatform/common/generalconfig/v1/apppushs/getAppList"
        tableview.inno_param?.id = id
        tableview.delegate = self
        tableview.dataSource = self
        tableview.separatorStyle = .none // 去除表单分割线
        tableview.rowHeight = UITableViewAutomaticDimension // 设置行高为自动适配
        tableview.estimatedRowHeight = 120.0 // 设置大概高度
        tableview.register(MessageListViewCell.self, forCellReuseIdentifier: CellID) // 创建一个可重用的单元格
        tableview.innoDelegate = self
        
        return tableview
    }()
    
    // 重复点击
    fileprivate var isSelect = false
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        // 初始化导航栏
        self.initNavBar(delegate: self)
        
        self.view.addSubview(myTableview)
        
        // 加载数据
        myTableview.refreshDatalist()
        
    }
    
}

// MARK: - 空页面代理
extension MessageListViewController : INNOUITableViewDelegate {
    
    func emptyDataView(_ view: UIScrollView?) -> UIView {
        
        let view = INNOEmptyView(frame: myTableview.bounds, title: "暂未收到任何消息！", buttonName: nil)
        
        return view
    }
}

// MARK: - <#UITableViewDelegate,UITableViewDataSource#>
extension MessageListViewController : UITableViewDelegate,UITableViewDataSource {
    
    // section数量
    func numberOfSections(in tableView: UITableView) -> Int {
        return 1
        
    }
    
    // 每个section的行数
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return myTableview.inno_datalist.count
    }
    
    // 绘制cell
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: CellID) as! MessageListViewCell
        cell.selectionStyle = .none
        cell.model = myTableview.inno_datalist[indexPath.row]
        
        return cell
    }
    
    // 点击事件
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        
        guard self.isSelect == false else {
            return
        }
        self.isSelect = true
        
        //在延时方法中将isSelect更改为false
        self.perform(#selector(repeatDelay), with: nil, afterDelay: 1)
        
        let model: UserNotifyMessageListDTO = myTableview.inno_datalist[indexPath.row]
        if let openParams = model.openParams {
            
            var jsonParam = INNOPageRoutesManager.instance.getDictionaryFromJSONString(jsonString: openParams)
            let pageId = jsonParam?["pageId"] ?? ""
            switch pageId {
            case "5002": // 企业认证
                break
            default:
                INNOPageRoutesManager.instance.openLinkUrl(openParams, shareinfo: nil)
                break
            }
            
        } else {
            INNOPageRoutesManager.instance.openMessageInfoPage(model.id, shareinfo: nil)
        }
    }
    
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        return 0.01
    }
    
    func tableView(_ tableView: UITableView, heightForFooterInSection section: Int) -> CGFloat {
        return 0.01
    }
    
    /// 解决列表重复点击的问题
    @objc func repeatDelay() {
        self.isSelect = false
    }
}

extension MessageListViewController : INNONavigationControllerDelegate {
    
    
    /// 初始化导航栏
    ///
    /// - Parameter controller: <#controller description#>
    func initNavBar(_ controller: INNOBaseViewController) {
        
        navBarShadowImageHidden = false
    }
}
